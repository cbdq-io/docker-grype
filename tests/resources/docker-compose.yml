---
version: "3"

services:
  docker:
    container_name: docker
    environment:
      DOCKER_TLS_CERTDIR: ""
    image: docker:dind
    healthcheck:
      test: ["CMD-SHELL", "docker", "ps"]
      interval: 10s
      timeout: 5s
      retries: 5
    privileged: true
    volumes:
      - ../..:/work
    working_dir: /work

  grype:
    command: sleep infinity
    container_name: grype
    environment:
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
    image: docker-grype:latest
    healthcheck:
      test: ["CMD-SHELL", "docker", "ps"]
      interval: 30s
      timeout: 30s
      retries: 5
    volumes:
      - .:/tmp


  sut:
    environment:
      ADD_CPES_IF_NONE: 0
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
      GRYPE_VERSION: "${GRYPE_VERSION}"
      IMAGE_NAME: docker-grype:latest
      LOG_LEVEL: DEBUG
      ONLY_FIXED: 1
      SHOW_ALL_VULNERABILITIES: 1
      VULNERABILITIES_ALLOWED_LIST: 'GHSA-69cg-p879-7622,GHSA-69ch-w2m2-3vjp,GHSA-fxg5-wq6x-vr4w,GHSA-r48q-9g5r-8q2h,GHSA-vvpx-j8f3-3w6h'
    image: docker-grype:latest

  sutA:
    environment:
      ADD_CPES_IF_NONE: 0
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
      GRYPE_VERSION: "${GRYPE_VERSION}"
      IMAGE_NAME: docker-grype:latest
      LOG_LEVEL: DEBUG
      ONLY_FIXED: 1
      SHOW_ALL_VULNERABILITIES: 1
      VULNERABILITIES_ALLOWED_LIST: 'GHSA-232p-vwff-86mp,GHSA-69cg-p879-7622,GHSA-69ch-w2m2-3vjp,GHSA-fxg5-wq6x-vr4w,GHSA-hqxw-f8mx-cpmw,GHSA-r48q-9g5r-8q2h,GHSA-vvpx-j8f3-3w6h'
    image: docker-grype:latest

  sutB:
    environment:
      ADD_CPES_IF_NONE: 1
      BY_CVE: 1
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
      GRYPE_VERSION: "${GRYPE_VERSION}"
      IMAGE_NAME: docker-grype:latest
      LOG_LEVEL: DEBUG
      ONLY_FIXED: 1
      VULNERABILITIES_ALLOWED_LIST: 'CVE-2022-1996,CVE-2022-27664,CVE-2022-32149,CVE-2022-41721,CVE-2022-41723,CVE-2023-28840,CVE-2023-36632'
    image: docker-grype:latest

  sutC:
    environment:
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
      GRYPE_VERSION: "${GRYPE_VERSION}"
      IMAGE_NAME: docker-grype:latest
      LOG_LEVEL: DEBUG
      SHOW_ALL_VULNERABILITIES: 1
      VULNERABILITIES_ALLOWED_LIST: 'CVE-2019-8457,CVE-2020-16156,CVE-2021-31239,CVE-2021-33560,CVE-2022-1304,CVE-2022-3715,CVE-2022-4899,CVE-2023-24329,CVE-2023-29491,CVE-2023-2953,CVE-2023-31484,CVE-2023-36632,GHSA-232p-vwff-86mp,GHSA-69cg-p879-7622,GHSA-69ch-w2m2-3vjp,GHSA-fxg5-wq6x-vr4w,GHSA-hqxw-f8mx-cpmw,GHSA-r48q-9g5r-8q2h,GHSA-vvpx-j8f3-3w6h'
    image: docker-grype:latest

  sutD:
    environment:
      ADD_CPES_IF_NONE: 1
      DOCKER_HOST: tcp://docker:2375
      DOCKER_TLS_CERTDIR: ""
      GRYPE_VERSION: "${GRYPE_VERSION}"
      IMAGE_NAME: docker-grype:latest
      LOG_LEVEL: DEBUG
      VULNERABILITIES_ALLOWED_LIST: 'CVE-2019-8457,CVE-2020-16156,CVE-2021-31239,CVE-2021-33560,CVE-2022-1304,CVE-2022-3715,CVE-2022-4899,CVE-2023-24329,CVE-2023-29491,CVE-2023-2953,CVE-2023-31484,GHSA-232p-vwff-86mp,GHSA-69cg-p879-7622,GHSA-69ch-w2m2-3vjp,GHSA-fxg5-wq6x-vr4w,GHSA-hqxw-f8mx-cpmw,GHSA-r48q-9g5r-8q2h,GHSA-vvpx-j8f3-3w6h'
    image: docker-grype:latest
